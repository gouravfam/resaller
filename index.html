<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ - Online Bazaar</title>
    
    <!-- Error Catcher (Hidden unless error) -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error:", message);
            // Alert user only if critical
            if(document.body) {
               // document.body.innerHTML += `<div style="color:red;padding:10px;">Error: ${message}</div>`;
            }
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .chat-box { height: 250px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION (Working) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmBGDRtxUt74omyAi6YH9BySWm7kUjpAU",
            authDomain: "reseller-729f0.firebaseapp.com",
            projectId: "reseller-729f0",
            storageBucket: "reseller-729f0.firebasestorage.app",
            messagingSenderId: "225176781360",
            appId: "1:225176781360:web:acb5099ac84cd4da87e3f5"
        };

        // --- 2. APP LOGIC ---
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let userId = null;
            let userName = null;
            let userProfile = {};
            let tempMobileNumber = "";

            // Auth Listener
            onAuthStateChanged(auth, async (user) => {
                document.getElementById('loading-screen').classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    await checkUserProfile(userId);
                } else {
                    signInAnonymously(auth).catch(e => alert("Login Error: " + e.message));
                }
            });

            // --- CORE FUNCTIONS ---
            const checkUserProfile = async (uid) => {
                const userRef = doc(db, 'users', uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    userName = userProfile.name;
                    showView('view-home');
                    startItemsListener(); // Default tab
                    updateUserDisplay();
                } else {
                    showView('view-login-mobile');
                }
            };

            const updateUserDisplay = () => {
                document.querySelectorAll('.user-name-display').forEach(el => el.textContent = userName || 'Guest');
                document.querySelectorAll('.user-photo-display').forEach(img => img.src = userProfile.photo || 'https://placehold.co/100');
            };

            // --- AUTH UI ---
            window.sendOtp = () => {
                const mobile = document.getElementById('login-mobile').value.trim();
                if (mobile.length !== 10) { alert('10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç'); return; }
                tempMobileNumber = mobile;
                showView('view-login-otp');
            };

            window.verifyOtp = () => {
                const otp = document.getElementById('login-otp').value.trim();
                if (otp.length < 4) { alert('Try 1234'); return; }
                document.getElementById('reg-mobile').value = tempMobileNumber;
                showView('view-register-profile');
            };

            window.saveProfile = async () => {
                const name = document.getElementById('reg-name').value.trim();
                const address = document.getElementById('reg-address').value.trim();
                const mobile = document.getElementById('reg-mobile').value.trim();
                const file = document.getElementById('reg-photo').files[0];

                if (!name || !address) { alert('Details bharein'); return; }

                let photoBase64 = null;
                if (file) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise(resolve => reader.onload = () => { photoBase64 = reader.result; resolve(); });
                }

                await setDoc(doc(db, 'users', userId), {
                    name, address, mobile, photo: photoBase64,
                    joinedAt: serverTimestamp()
                }, { merge: true });

                userProfile = { name, address, mobile, photo: photoBase64 };
                userName = name;
                updateUserDisplay();
                showView('view-home');
                startItemsListener();
            };

            // --- HOME TABS ---
            window.switchHomeTab = (tab) => {
                // UI Update
                document.getElementById('tab-items').className = "flex-1 py-3 font-bold text-gray-400 transition";
                document.getElementById('tab-requests').className = "flex-1 py-3 font-bold text-gray-400 transition";
                
                document.getElementById(`tab-${tab}`).className = "flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition";

                // Logic Update
                if(tab === 'items') startItemsListener();
                else startRequestsListener();
            };

            // --- LIST ITEMS ---
            window.startItemsListener = () => {
                const q = query(collection(db, 'items'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">‡§ï‡•ã‡§à ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>'; return; }
                    
                    snap.forEach(d => {
                        const item = d.data();
                        if (item.status !== 'sold') {
                            const div = document.createElement('div');
                            div.className = 'bg-white rounded-2xl shadow-sm hover:shadow-lg transition overflow-hidden border border-gray-100 cursor-pointer fade-in';
                            div.onclick = (e) => { if(!e.target.closest('button')) showItemDetails(d.id, item.sellerId); };
                            div.innerHTML = `
                                <div class="relative h-48 overflow-hidden">
                                    <img src="${item.imageData}" class="w-full h-full object-cover" alt="${item.name}">
                                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-3">
                                        <span class="text-white font-bold text-lg">‚Çπ ${item.price}</span>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h3 class="font-bold text-gray-800 truncate">${item.name}</h3>
                                    <p class="text-xs text-gray-500 mb-2">${item.category}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-400">By: ${item.sellerName ? item.sellerName.split(' ')[0] : 'User'}</span>
                                        <button class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç</button>
                                    </div>
                                </div>`;
                            list.appendChild(div);
                        }
                    });
                });
            };

            // --- LIST REQUESTS ---
            window.startRequestsListener = () => {
                const q = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">‡§ï‡•ã‡§à ‡§Æ‡§æ‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>'; return; }
                    snap.forEach(d => {
                        const req = d.data();
                        const div = document.createElement('div');
                        div.className = 'bg-white rounded-2xl p-5 shadow-sm border border-orange-100 relative fade-in';
                        div.innerHTML = `
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-bl-xl font-bold">WANTED</div>
                            <h3 class="font-bold text-lg text-gray-800">${req.itemName}</h3>
                            <p class="text-gray-600 text-sm mt-1">${req.description}</p>
                            <div class="flex items-center gap-2 mt-4 pt-3 border-t border-gray-50">
                                <img src="${req.requesterPhoto || 'https://placehold.co/50'}" class="w-8 h-8 rounded-full object-cover">
                                <div class="text-xs">
                                    <p class="font-bold">${req.requesterName}</p>
                                    <p class="text-gray-400">‡§ï‡•ã ‡§ö‡§æ‡§π‡§ø‡§è</p>
                                </div>
                            </div>`;
                        list.appendChild(div);
                    });
                });
            };

            // --- SUBMIT ITEM ---
            window.submitSell = async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-sell');
                const file = document.getElementById('inp-file').files[0];
                if(!file) { alert('Photo chahiye'); return; }
                
                // Loading state
                const btn = e.target.querySelector('button');
                btn.innerText = "Uploading..."; btn.disabled = true;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    await addDoc(collection(db, 'items'), {
                        name: form['name'].value, price: Number(form['price'].value),
                        category: form['category'].value, description: form['desc'].value,
                        imageData: reader.result, sellerId: userId, sellerName: userName, sellerPhoto: userProfile.photo,
                        status: 'available', createdAt: serverTimestamp()
                    });
                    form.reset();
                    btn.innerText = "Post Ad"; btn.disabled = false;
                    showView('view-home');
                    switchHomeTab('items');
                };
            };

            // --- SUBMIT REQUEST ---
            window.submitRequest = async (e) => {
                e.preventDefault();
                const name = document.getElementById('req-name').value;
                const desc = document.getElementById('req-desc').value;
                await addDoc(collection(db, 'requests'), {
                    itemName: name, description: desc,
                    requesterId: userId, requesterName: userName, requesterPhoto: userProfile.photo,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-request').reset();
                showView('view-home');
                switchHomeTab('requests');
            };

            // --- ITEM DETAILS + DEALS ---
            let dealsUnsub;
            window.showItemDetails = async (itemId, sellerId) => {
                const iSnap = await getDoc(doc(db, 'items', itemId));
                const sSnap = await getDoc(doc(db, 'users', sellerId));
                
                if(!iSnap.exists()) return;
                const item = iSnap.data();
                const seller = sSnap.exists() ? sSnap.data() : {name:'User', mobile:'Hidden'};

                // Fill UI
                document.getElementById('det-img').src = item.imageData;
                document.getElementById('det-title').innerText = item.name;
                document.getElementById('det-price').innerText = `‚Çπ ${item.price}`;
                document.getElementById('det-desc').innerText = item.description || "No description";
                
                document.getElementById('det-seller-photo').src = seller.photo || 'https://placehold.co/100';
                document.getElementById('det-seller-name').innerText = seller.name;
                document.getElementById('det-seller-mobile').innerText = seller.mobile;
                document.getElementById('chat-item-id').value = itemId;

                // --- DEAL LOGIC ---
                const controls = document.getElementById('deal-controls');
                controls.innerHTML = '<p class="text-sm text-gray-400">Loading Status...</p>';
                
                if(dealsUnsub) dealsUnsub();
                const q = query(collection(db, 'deals'), where('itemId', '==', itemId));
                
                dealsUnsub = onSnapshot(q, (snap) => {
                    controls.innerHTML = '';
                    
                    if (sellerId === userId) {
                        // I AM SELLER
                        controls.innerHTML = '<h3 class="font-bold mb-2 text-sm">‡§ñ‡§∞‡•Ä‡§¶‡§®‡•á ‡§ï‡•Ä ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü:</h3>';
                        if(snap.empty) controls.innerHTML += '<p class="text-xs text-gray-500">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç‡•§</p>';
                        
                        snap.forEach(d => {
                            const deal = d.data();
                            if(deal.status === 'pending') {
                                controls.innerHTML += `
                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-2 flex justify-between items-center">
                                    <div>
                                        <p class="font-bold text-sm text-indigo-900">${deal.buyerName}</p>
                                        <p class="text-xs text-indigo-600">‡§ñ‡§∞‡•Ä‡§¶‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•à</p>
                                    </div>
                                    <button onclick="acceptDeal('${d.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs shadow">Accept</button>
                                </div>`;
                            } else if(deal.status === 'accepted') {
                                controls.innerHTML += `
                                <div class="bg-green-50 p-3 rounded-lg border border-green-200 mb-2">
                                    <p class="text-green-800 text-xs font-bold">Deal Accepted: ${deal.buyerName}</p>
                                    <p class="text-green-700 text-xs mt-1">Meeting: ${deal.meetTime} @ ${deal.meetPlace}</p>
                                </div>`;
                            }
                        });
                    } else {
                        // I AM BUYER
                        const myDeal = snap.docs.find(d => d.data().buyerId === userId);
                        if (!myDeal) {
                            controls.innerHTML = `<button onclick="sendDealRequest('${itemId}')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">Yes, I want to buy</button>`;
                        } else {
                            const status = myDeal.data().status;
                            if(status === 'pending') controls.innerHTML = `<div class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-bold border border-yellow-200">‡§®‡§ø‡§µ‡•á‡§¶‡§® ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ (Pending)</div>`;
                            else if(status === 'accepted') controls.innerHTML = `<div class="bg-green-100 p-4 rounded-xl text-center border border-green-200"><p class="text-green-800 font-bold text-lg">üéâ Deal Confirmed!</p><p class="text-sm text-green-700 mt-1">${myDeal.data().meetTime} @ ${myDeal.data().meetPlace}</p></div>`;
                        }
                    }
                });

                setupChat(itemId);
                showView('view-details');
            };

            window.sendDealRequest = async (itemId) => {
                await addDoc(collection(db, 'deals'), {
                    itemId, buyerId: userId, buyerName: userName, status: 'pending', createdAt: serverTimestamp()
                });
            };

            window.acceptDeal = (dealId) => {
                document.getElementById('modal-deal-id').value = dealId;
                document.getElementById('modal-logistics').classList.remove('hidden');
            };

            window.confirmDeal = async () => {
                const dealId = document.getElementById('modal-deal-id').value;
                const time = document.getElementById('deal-time').value;
                const place = document.getElementById('deal-place').value;
                if(!time || !place) return;
                
                await updateDoc(doc(db, 'deals', dealId), { status: 'accepted', meetTime: time, meetPlace: place });
                document.getElementById('modal-logistics').classList.add('hidden');
            };

            // --- CHAT SYSTEM ---
            const setupChat = (itemId) => {
                const chatDiv = document.getElementById('chat-messages');
                const q = query(collection(db, 'chats', itemId, 'messages'), orderBy('createdAt', 'asc'));
                onSnapshot(q, (snap) => {
                    chatDiv.innerHTML = '';
                    if(snap.empty) chatDiv.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Start discussion...</p>';
                    snap.forEach(d => {
                        const msg = d.data();
                        const isMe = msg.senderId === userId;
                        chatDiv.innerHTML += `
                        <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-2 fade-in">
                            <div class="px-3 py-2 rounded-2xl text-xs max-w-[80%] ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border text-gray-700 rounded-bl-none'}">
                                ${msg.text}
                            </div>
                        </div>`;
                    });
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                });
            };

            window.sendChat = async (e) => {
                e.preventDefault();
                const txt = document.getElementById('inp-chat').value.trim();
                const itemId = document.getElementById('chat-item-id').value;
                if(!txt) return;
                await addDoc(collection(db, 'chats', itemId, 'messages'), { text: txt, senderId: userId, createdAt: serverTimestamp() });
                document.getElementById('inp-chat').value = '';
            };

            // --- FULL PROFILE ---
            window.showFullProfile = async () => {
                 document.getElementById('prof-img').src = userProfile.photo || 'https://placehold.co/150';
                 document.getElementById('prof-name').innerText = userProfile.name;
                 document.getElementById('prof-mobile').innerText = userProfile.mobile;
                 document.getElementById('prof-address').innerText = userProfile.address;

                 // Stats
                 const itemsQ = query(collection(db, 'items'), where('sellerId', '==', userId));
                 onSnapshot(itemsQ, s => document.getElementById('stat-sold').innerText = s.size);
                 
                 // History
                 const histList = document.getElementById('history-list');
                 histList.innerHTML = '<p class="text-xs text-gray-400">Loading...</p>';
                 
                 // Simple query for deals where I am buyer or seller (requires 2 queries or client filter)
                 // Client filter for simplicity
                 const allDeals = query(collection(db, 'deals'), where('status', '==', 'accepted'));
                 onSnapshot(allDeals, (snap) => {
                    histList.innerHTML = '';
                    let count = 0;
                    snap.forEach(d => {
                        const deal = d.data();
                        // Manual filtering because Firestore OR queries are complex
                        // We assume item seller ID is fetched, but here we simplify: 
                        // If I am buyer, I bought. Logic for "Sold" needs item lookup, 
                        // but for now we just show what we can easily.
                        if (deal.buyerId === userId) {
                            count++;
                            histList.innerHTML += `
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded mb-2 border border-slate-100">
                                <div>
                                    <p class="font-bold text-sm text-slate-700">Item Bought</p>
                                    <p class="text-xs text-gray-400">${deal.meetTime}</p>
                                </div>
                                <span class="text-red-500 font-bold text-xs">Debit</span>
                            </div>`;
                        }
                    });
                    if(count === 0) histList.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">No transaction history.</p>';
                 });

                 showView('view-profile-full');
            };

            // --- VIEW NAV ---
            window.showView = (id) => {
                document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                window.scrollTo(0,0);
            };

        } catch (error) {
            console.error(error);
            alert("App Error: " + error.message);
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen relative pb-20">

    <!-- LOADING -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-500 font-medium">Bazaar Opening...</p>
    </div>

    <!-- MODAL LOGISTICS -->
    <div id="modal-logistics" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-bounce-in">
            <h3 class="font-bold text-lg mb-4 text-indigo-900">Confirm Deal</h3>
            <p class="text-xs text-gray-500 mb-4">Buyer ko batayein kahan aana hai.</p>
            <input type="hidden" id="modal-deal-id">
            <div class="space-y-3">
                <input id="deal-time" class="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:ring-2 ring-indigo-200" placeholder="‡§ï‡§¨? (Date & Time)">
                <input id="deal-place" class="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:ring-2 ring-indigo-200" placeholder="‡§ï‡§π‡§æ‡§Å? (Location)">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('modal-logistics').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-600">Cancel</button>
                <button onclick="confirmDeal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-200">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 1. LOGIN -->
    <div id="view-login-mobile" class="app-view hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mb-6 text-3xl">üõçÔ∏è</div>
        <h1 class="text-3xl font-bold text-slate-900 mb-8">Bazaar Login</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="login-mobile" type="tel" class="w-full p-4 border rounded-xl text-lg bg-slate-50 outline-none focus:border-indigo-500" placeholder="Mobile Number">
            <button onclick="sendOtp()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl shadow-indigo-200">Get OTP</button>
        </div>
    </div>

    <!-- 2. OTP -->
    <div id="view-login-otp" class="app-view hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <h2 class="text-2xl font-bold mb-4">Enter OTP</h2>
        <input id="login-otp" type="number" class="w-full max-w-sm p-4 border rounded-xl text-center text-2xl tracking-widest mb-6 outline-none focus:border-indigo-500" placeholder="1234">
        <button onclick="verifyOtp()" class="w-full max-w-sm bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl">Verify</button>
    </div>

    <!-- 3. PROFILE SETUP -->
    <div id="view-register-profile" class="app-view hidden min-h-screen p-6 bg-white flex flex-col justify-center">
        <h2 class="text-2xl font-bold mb-6 text-center">Complete Profile</h2>
        <div class="max-w-sm mx-auto w-full space-y-4">
            <div class="relative w-24 h-24 mx-auto mb-6 bg-slate-100 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center">
                <input id="reg-photo" type="file" class="absolute inset-0 opacity-0 z-10 w-full h-full">
                <span class="text-xs text-gray-400">Photo</span>
            </div>
            <input id="reg-name" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Full Name">
            <input id="reg-mobile" type="text" disabled class="w-full p-3 bg-slate-100 rounded-xl text-gray-500">
            <textarea id="reg-address" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="City / Address"></textarea>
            <button onclick="saveProfile()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg">Save Profile</button>
        </div>
    </div>

    <!-- 4. HOME -->
    <div id="view-home" class="app-view hidden">
        <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b flex justify-between items-center px-4 h-16 shadow-sm">
            <div class="font-bold text-xl text-indigo-700 flex items-center gap-2"><span>üõçÔ∏è</span> Bazaar</div>
            <div onclick="showFullProfile()" class="flex items-center gap-2 cursor-pointer bg-indigo-50 py-1.5 px-3 rounded-full border border-indigo-100">
                <img class="w-6 h-6 rounded-full object-cover user-photo-display" src="">
                <span class="text-sm font-bold text-indigo-900 user-name-display">User</span>
            </div>
        </nav>
        
        <!-- Tabs -->
        <div class="flex border-b bg-white sticky top-16 z-30 shadow-sm">
            <button id="tab-items" onclick="switchHomeTab('items')" class="flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition">‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ (Items)</button>
            <button id="tab-requests" onclick="switchHomeTab('requests')" class="flex-1 py-3 font-bold text-gray-400 transition">‡§Æ‡§æ‡§Ç‡§ó (Requests)</button>
        </div>

        <main class="max-w-5xl mx-auto px-4 py-6 pb-24">
            <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>

        <!-- Floating Buttons -->
        <div class="fixed bottom-24 right-6 flex flex-col gap-4 z-30">
            <button onclick="showView('view-request-add')" class="w-12 h-12 bg-white text-orange-500 rounded-full shadow-lg border border-orange-100 flex items-center justify-center transform hover:scale-110 transition" title="Ask Item">üì¢</button>
            <button onclick="showView('view-sell')" class="w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl shadow-indigo-300 flex items-center justify-center text-2xl transform hover:scale-110 transition">‚ûï</button>
        </div>
    </div>

    <!-- 5. SELL -->
    <div id="view-sell" class="app-view hidden bg-white min-h-screen">
        <div class="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-40">
            <button onclick="showView('view-home')" class="p-2 rounded-full hover:bg-slate-100">‚¨Ö</button>
            <h2 class="font-bold text-xl">Sell Item</h2>
        </div>
        <div class="p-6 max-w-lg mx-auto">
            <form id="form-sell" onsubmit="submitSell(event)" class="space-y-4">
                <div class="relative h-40 bg-slate-50 border-2 border-dashed border-indigo-200 rounded-xl flex items-center justify-center">
                    <input id="inp-file" type="file" class="absolute inset-0 opacity-0 w-full h-full z-10">
                    <span class="text-indigo-400 font-bold">üì∏ Click to Upload Photo</span>
                </div>
                <input name="name" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-indigo-100" placeholder="Product Name" required>
                <div class="flex gap-4">
                    <input name="price" type="number" class="w-1/2 p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Price ‚Çπ" required>
                    <input name="category" class="w-1/2 p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Category" required>
                </div>
                <textarea name="desc" class="w-full p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Description..."></textarea>
                <button class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Post Ad</button>
            </form>
        </div>
    </div>

    <!-- 6. ADD REQUEST -->
    <div id="view-request-add" class="app-view hidden bg-white min-h-screen">
        <div class="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-40">
            <button onclick="showView('view-home')" class="p-2 rounded-full hover:bg-slate-100">‚¨Ö</button>
            <h2 class="font-bold text-xl">Request Item</h2>
        </div>
        <div class="p-6 max-w-lg mx-auto">
            <div class="bg-orange-50 text-orange-800 p-4 rounded-xl text-sm mb-6 border border-orange-100">
                Kuch chahiye jo market mein nahi mil raha? Yahan post karein.
            </div>
            <form id="form-request" onsubmit="submitRequest(event)" class="space-y-4">
                <input id="req-name" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-orange-100" placeholder="Item Name (Ex: Old Physics Book)" required>
                <textarea id="req-desc" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-orange-100" placeholder="Details (Budget, Condition etc.)" required></textarea>
                <button class="w-full py-4 bg-orange-500 text-white font-bold rounded-xl shadow-lg shadow-orange-200">Post Request</button>
            </form>
        </div>
    </div>

    <!-- 7. DETAILS & CHAT -->
    <div id="view-details" class="app-view hidden bg-white min-h-screen pb-20">
        <!-- Header Image -->
        <div class="relative h-72 bg-slate-900">
            <img id="det-img" class="w-full h-full object-cover opacity-90">
            <button onclick="showView('view-home')" class="absolute top-4 left-4 bg-white/20 backdrop-blur p-2 rounded-full text-white hover:bg-white/40 transition-colors">‚¨Ö</button>
        </div>

        <div class="max-w-3xl mx-auto -mt-6 relative bg-white rounded-t-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <h2 id="det-title" class="text-2xl font-bold text-slate-800 w-2/3 leading-tight">Title</h2>
                <p id="det-price" class="text-2xl font-bold text-indigo-600">‚Çπ0</p>
            </div>
            
            <p id="det-desc" class="text-slate-600 leading-relaxed mb-6">Desc...</p>

            <!-- Seller Card -->
            <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6">
                <img id="det-seller-photo" class="w-12 h-12 rounded-full object-cover bg-white border">
                <div>
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Owner</p>
                    <p id="det-seller-name" class="font-bold text-slate-800">Name</p>
                    <p id="det-seller-mobile" class="text-xs text-gray-500">Mobile Hidden</p>
                </div>
            </div>

            <!-- DEAL ACTIONS -->
            <div id="deal-controls" class="mb-8">
                <!-- JS fills this -->
            </div>

            <!-- Chat -->
            <div class="border-t pt-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">üí¨ Discussion</h3>
                <div id="chat-messages" class="chat-box bg-slate-50 rounded-xl border border-slate-200 p-4 mb-4 overflow-y-auto shadow-inner">
                    <!-- Messages -->
                </div>
                <form onsubmit="sendChat(event)" class="flex gap-2">
                    <input type="hidden" id="chat-item-id">
                    <input id="inp-chat" class="flex-1 p-3 bg-white border rounded-xl outline-none focus:ring-2 ring-indigo-100" placeholder="Type a message...">
                    <button class="bg-indigo-600 text-white px-5 rounded-xl font-bold shadow-lg">Send</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 8. FULL PROFILE -->
    <div id="view-profile-full" class="app-view hidden bg-white min-h-screen">
        <div class="bg-indigo-600 p-6 text-white pt-10 pb-20 relative rounded-b-[2.5rem] shadow-xl">
            <button onclick="showView('view-home')" class="absolute top-4 left-4 bg-white/20 p-2 rounded-full">‚¨Ö</button>
            <div class="flex flex-col items-center">
                <img id="prof-img" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover shadow-lg mb-3" src="">
                <h2 id="prof-name" class="text-2xl font-bold">User</h2>
                <p id="prof-mobile" class="text-indigo-200">Mobile</p>
            </div>
        </div>
        
        <div class="max-w-3xl mx-auto px-6 -mt-12">
            <!-- Info Card -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase">Address</p>
                        <p id="prof-address" class="text-slate-800 font-medium mt-1">Address...</p>
                    </div>
                </div>
                <div class="flex pt-4 border-t">
                    <div class="flex-1 text-center border-r">
                        <p id="stat-sold" class="text-2xl font-bold text-indigo-600">0</p>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Active Ads</p>
                    </div>
                    <div class="flex-1 text-center">
                        <p class="text-2xl font-bold text-green-600">Free</p>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Plan</p>
                    </div>
                </div>
            </div>

            <!-- Transactions -->
            <h3 class="font-bold text-lg mb-3 ml-1">Purchases</h3>
            <div id="history-list" class="space-y-3 pb-10">
                <!-- JS fills -->
            </div>
        </div>
    </div>

</body>
</html>
