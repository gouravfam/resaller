<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ - Online Bazaar</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error:", message);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .chat-box { height: 250px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmBGDRtxUt74omyAi6YH9BySWm7kUjpAU",
            authDomain: "reseller-729f0.firebaseapp.com",
            projectId: "reseller-729f0",
            storageBucket: "reseller-729f0.firebasestorage.app",
            messagingSenderId: "225176781360",
            appId: "1:225176781360:web:acb5099ac84cd4da87e3f5"
        };

        // --- 2. APP LOGIC ---
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let userId = null;
            let userName = null;
            let userProfile = {};

            // Auth Listener
            onAuthStateChanged(auth, async (user) => {
                document.getElementById('loading-screen').classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    await checkUserProfile(userId);
                } else {
                    // User logged out
                    showView('view-login');
                }
            });

            // --- CORE FUNCTIONS ---
            const checkUserProfile = async (uid) => {
                const userRef = doc(db, 'users', uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    userName = userProfile.name;
                    showView('view-home');
                    startItemsListener(); 
                    updateUserDisplay();
                    startNotificationListener(uid);
                } else {
                    // Profile data missing?
                    alert("Profile data not found. Please contact support.");
                    showView('view-login');
                }
            };

            const updateUserDisplay = () => {
                document.querySelectorAll('.user-name-display').forEach(el => el.textContent = userName || 'User');
                document.querySelectorAll('.user-photo-display').forEach(img => img.src = userProfile.photo || 'https://placehold.co/100');
            };

            // --- PASSWORD AUTH LOGIC ---
            
            // 1. LOGIN
            window.handleLogin = async () => {
                const mobile = document.getElementById('login-mobile').value.trim();
                const pass = document.getElementById('login-pass').value.trim();
                const btn = document.getElementById('btn-login');

                if (mobile.length !== 10) { showToast('Mobile number 10 digit ka hona chahiye', 'error'); return; }
                if (!pass) { showToast('Password dalein', 'error'); return; }

                btn.innerText = "Checking..."; btn.disabled = true;

                // Fake Email conversion for Firebase
                const email = `${mobile}@bazaar.com`;

                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    showToast("Login Successful!", 'success');
                    // onAuthStateChanged will handle redirect
                } catch (error) {
                    console.error(error);
                    let msg = "Login Failed.";
                    if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') msg = "Number ya Password galat hai.";
                    if(error.code === 'auth/user-not-found') msg = "Ye account nahi mila. Register karein.";
                    showToast(msg, 'error');
                    btn.innerText = "Login"; btn.disabled = false;
                }
            };

            // 2. SIGNUP (REGISTER)
            window.handleSignup = async () => {
                const name = document.getElementById('reg-name').value.trim();
                const mobile = document.getElementById('reg-mobile').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();
                const address = document.getElementById('reg-address').value.trim();
                const file = document.getElementById('reg-photo').files[0];
                const btn = document.getElementById('btn-signup');

                // Validation
                if (name.length < 3) { showToast('Pura naam likhein', 'error'); return; }
                if (mobile.length !== 10) { showToast('Mobile number 10 digit ka hona chahiye', 'error'); return; }
                if (address.length < 5) { showToast('Pura pata (Address) likhein', 'error'); return; }
                
                // Strong Password Check
                if (pass.length < 6) { showToast('Password kam se kam 6 akshar ka ho', 'error'); return; }
                // Optional: Check for numbers/letters mix
                // if (!/\d/.test(pass)) { showToast('Password me number bhi hone chahiye', 'error'); return; }

                btn.innerText = "Creating Account..."; btn.disabled = true;

                // 1. Compress Image if exists
                let photoBase64 = null;
                if (file) {
                    try { photoBase64 = await compressImage(file); } 
                    catch(e) { showToast("Image Error", 'error'); btn.disabled = false; return; }
                }

                const email = `${mobile}@bazaar.com`;

                try {
                    // 2. Create Auth User
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;

                    // 3. Save Profile Data to Firestore
                    await setDoc(doc(db, 'users', user.uid), {
                        name, mobile, address, photo: photoBase64,
                        createdAt: serverTimestamp()
                    });

                    // 4. Update Auth Profile Name
                    await updateProfile(user, { displayName: name });

                    showToast("Account Created! Welcome.", 'success');
                    // onAuthStateChanged will redirect
                } catch (error) {
                    console.error(error);
                    let msg = "Signup Failed.";
                    if(error.code === 'auth/email-already-in-use') msg = "Ye Number pehle se registered hai. Login karein.";
                    if(error.code === 'auth/weak-password') msg = "Password bahut kamzor hai.";
                    showToast(msg, 'error');
                    btn.innerText = "Create Account"; btn.disabled = false;
                }
            };

            window.handleLogout = async () => {
                await signOut(auth);
                showToast("Logged Out", 'info');
                showView('view-login');
            };

            // --- IMAGE COMPRESSION ---
            const compressImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            } else {
                                if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            };

            // --- HOME TABS ---
            window.switchHomeTab = (tab) => {
                document.getElementById('tab-items').className = "flex-1 py-3 font-bold text-gray-400 transition";
                document.getElementById('tab-requests').className = "flex-1 py-3 font-bold text-gray-400 transition";
                document.getElementById(`tab-${tab}`).className = "flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition";
                if(tab === 'items') startItemsListener(); else startRequestsListener();
            };

            // --- LISTINGS ---
            window.startItemsListener = () => {
                const q = query(collection(db, 'items'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">Koi saman nahi hai.</p>'; return; }
                    
                    snap.forEach(d => {
                        const item = d.data();
                        if (item.status !== 'sold') {
                            const div = document.createElement('div');
                            div.className = 'bg-white rounded-2xl shadow-sm hover:shadow-lg transition overflow-hidden border border-gray-100 cursor-pointer fade-in';
                            div.onclick = (e) => { if(!e.target.closest('button')) showItemDetails(d.id, item.sellerId); };
                            div.innerHTML = `
                                <div class="relative h-48 overflow-hidden">
                                    <img src="${item.imageData}" class="w-full h-full object-cover" alt="${item.name}">
                                    <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-3">
                                        <span class="text-white font-bold text-lg">‚Çπ ${item.price}</span>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h3 class="font-bold text-gray-800 truncate">${item.name}</h3>
                                    <p class="text-xs text-gray-500 mb-2">${item.category}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-400">By: ${item.sellerName ? item.sellerName.split(' ')[0] : 'User'}</span>
                                        <button class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Dekhein</button>
                                    </div>
                                </div>`;
                            list.appendChild(div);
                        }
                    });
                });
            };

            window.startRequestsListener = () => {
                const q = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">Koi maang nahi hai.</p>'; return; }
                    snap.forEach(d => {
                        const req = d.data();
                        const div = document.createElement('div');
                        div.className = 'bg-white rounded-2xl p-5 shadow-sm border border-orange-100 relative fade-in';
                        div.innerHTML = `
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-bl-xl font-bold">CHAHIYE</div>
                            <h3 class="font-bold text-lg text-gray-800">${req.itemName}</h3>
                            <p class="text-gray-600 text-sm mt-1">${req.description}</p>
                            <div class="flex items-center gap-2 mt-4 pt-3 border-t border-gray-50">
                                <img src="${req.requesterPhoto || 'https://placehold.co/50'}" class="w-8 h-8 rounded-full object-cover">
                                <div class="text-xs">
                                    <p class="font-bold">${req.requesterName}</p>
                                    <p class="text-gray-400">ko chahiye</p>
                                </div>
                            </div>`;
                        list.appendChild(div);
                    });
                });
            };

            // --- SUBMIT FORMS ---
            window.submitSell = async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-sell');
                const file = document.getElementById('inp-file').files[0];
                if(!file) { showToast('Photo zaroori hai', 'error'); return; }
                
                const btn = e.target.querySelector('button');
                btn.innerText = "Uploading..."; btn.disabled = true;

                try {
                    const photoBase64 = await compressImage(file);
                    await addDoc(collection(db, 'items'), {
                        name: form['name'].value, price: Number(form['price'].value),
                        category: form['category'].value, description: form['desc'].value,
                        imageData: photoBase64, sellerId: userId, sellerName: userName, sellerPhoto: userProfile.photo,
                        status: 'available', createdAt: serverTimestamp()
                    });
                    form.reset();
                    btn.innerText = "Post Ad"; btn.disabled = false;
                    showView('view-home');
                    switchHomeTab('items');
                    showToast("Item Listed!", 'success');
                } catch(err) { showToast("Error: " + err.message, 'error'); btn.disabled = false; }
            };

            window.submitRequest = async (e) => {
                e.preventDefault();
                const name = document.getElementById('req-name').value;
                const desc = document.getElementById('req-desc').value;
                await addDoc(collection(db, 'requests'), {
                    itemName: name, description: desc,
                    requesterId: userId, requesterName: userName, requesterPhoto: userProfile.photo,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-request').reset();
                showView('view-home');
                switchHomeTab('requests');
                showToast("Request Posted!", 'success');
            };

            // --- DEAL LOGIC ---
            let dealsUnsub;
            let activeDealId = null; 

            window.showItemDetails = async (itemId, sellerId) => {
                const iSnap = await getDoc(doc(db, 'items', itemId));
                const sSnap = await getDoc(doc(db, 'users', sellerId));
                
                if(!iSnap.exists()) return;
                const item = iSnap.data();
                const seller = sSnap.exists() ? sSnap.data() : {name:'User', mobile:'Hidden'};

                document.getElementById('det-img').src = item.imageData;
                document.getElementById('det-title').innerText = item.name;
                document.getElementById('det-price').innerText = `‚Çπ ${item.price}`;
                document.getElementById('det-desc').innerText = item.description || "No description";
                document.getElementById('det-seller-photo').src = seller.photo || 'https://placehold.co/100';
                document.getElementById('det-seller-name').innerText = seller.name;
                document.getElementById('det-seller-mobile').innerText = seller.mobile;
                
                const controls = document.getElementById('deal-controls');
                controls.innerHTML = '<p class="text-sm text-gray-400">Loading...</p>';
                
                if(dealsUnsub) dealsUnsub();
                const q = query(collection(db, 'deals'), where('itemId', '==', itemId));
                
                dealsUnsub = onSnapshot(q, (snap) => {
                    controls.innerHTML = '';
                    
                    if (sellerId === userId) {
                        // SELLER VIEW
                        controls.innerHTML = '<h3 class="font-bold mb-2 text-sm">Requests Received:</h3>';
                        if(snap.empty) controls.innerHTML += '<p class="text-xs text-gray-500">Koi request nahi.</p>';
                        
                        snap.forEach(d => {
                            const deal = d.data();
                            activeDealId = d.id; 
                            
                            if(deal.status === 'pending') {
                                controls.innerHTML += `
                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-2 flex justify-between items-center">
                                    <div><p class="font-bold text-sm text-indigo-900">${deal.buyerName}</p></div>
                                    <button onclick="acceptDeal('${d.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs shadow">Accept</button>
                                </div>`;
                            } else if(deal.status === 'accepted') {
                                controls.innerHTML += `<div class="bg-green-50 p-3 rounded-lg border border-green-200 mb-2"><p class="text-green-800 text-xs font-bold">Deal Accepted with ${deal.buyerName}</p><p class="text-green-700 text-xs mt-1">Milaap: ${deal.meetDate} at ${deal.meetTime} (${deal.meetPlace})</p></div>`;
                            }
                        });
                    } else {
                        // BUYER VIEW
                        const myDeal = snap.docs.find(d => d.data().buyerId === userId);
                        if (!myDeal) {
                            controls.innerHTML = `<button onclick="sendDealRequest('${itemId}', '${sellerId}')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Yes, I want to buy</button>`;
                        } else {
                            const deal = myDeal.data();
                            activeDealId = myDeal.id; 
                            
                            if(deal.status === 'pending') controls.innerHTML = `<div class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-bold border border-yellow-200">Request Bheji Gayi (Pending)</div>`;
                            else if(deal.status === 'accepted') controls.innerHTML = `<div class="bg-green-100 p-4 rounded-xl text-center border border-green-200"><p class="text-green-800 font-bold text-lg">üéâ Deal Confirmed!</p><p class="text-sm text-green-700 mt-1">${deal.meetDate} at ${deal.meetTime}<br>@ ${deal.meetPlace}</p></div>`;
                        }
                    }
                    if(activeDealId) setupChat(activeDealId);
                    else document.getElementById('chat-messages').innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Request bhejne ke baad chat karein.</p>';
                });

                showView('view-details');
            };

            window.sendDealRequest = async (itemId, sellerId) => {
                await addDoc(collection(db, 'deals'), {
                    itemId, sellerId: sellerId, buyerId: userId, buyerName: userName, 
                    itemName: document.getElementById('det-title').innerText, 
                    status: 'pending', createdAt: serverTimestamp()
                });
                showToast("Request Sent!", 'success');
            };

            window.acceptDeal = (dealId) => {
                document.getElementById('modal-deal-id').value = dealId;
                document.getElementById('modal-logistics').classList.remove('hidden');
            };

            window.confirmDeal = async () => {
                const dealId = document.getElementById('modal-deal-id').value;
                const date = document.getElementById('deal-date').value;
                const time = document.getElementById('deal-time').value;
                const place = document.getElementById('deal-place').value;
                if(!date || !time || !place) { showToast("Details bharein", 'error'); return; }
                
                await updateDoc(doc(db, 'deals', dealId), { status: 'accepted', meetDate: date, meetTime: time, meetPlace: place });
                document.getElementById('modal-logistics').classList.add('hidden');
                showToast("Deal Confirmed!", 'success');
            };

            const setupChat = (dealId) => {
                const chatDiv = document.getElementById('chat-messages');
                const q = query(collection(db, 'deals', dealId, 'messages'), orderBy('createdAt', 'asc'));
                
                onSnapshot(q, (snap) => {
                    chatDiv.innerHTML = '';
                    if(snap.empty) chatDiv.innerHTML = '<p class="text-center text-xs text-gray-400 mt-4">Start discussion...</p>';
                    snap.forEach(d => {
                        const msg = d.data();
                        const isMe = msg.senderId === userId;
                        chatDiv.innerHTML += `<div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-2 fade-in"><div class="px-3 py-2 rounded-2xl text-xs max-w-[80%] ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border text-gray-700 rounded-bl-none'}">${msg.text}</div></div>`;
                    });
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                });
            };

            window.sendChat = async (e) => {
                e.preventDefault();
                if(!activeDealId) { showToast("Pehle Deal Request bhejein", 'error'); return; }
                const txt = document.getElementById('inp-chat').value.trim();
                if(!txt) return;
                
                await addDoc(collection(db, 'deals', activeDealId, 'messages'), { text: txt, senderId: userId, createdAt: serverTimestamp() });
                await updateDoc(doc(db, 'deals', activeDealId), { lastMsg: txt, lastMsgSender: userId, lastMsgTime: serverTimestamp() });
                document.getElementById('inp-chat').value = '';
            };

            const playNotificationSound = () => {
                const audio = document.getElementById('notif-sound');
                if(audio) audio.play().catch(e => {});
            };

            const startNotificationListener = (uid) => {
                const qSeller = query(collection(db, 'deals'), where('sellerId', '==', uid));
                onSnapshot(qSeller, (snapshot) => {
                    if (!snapshot.metadata.fromCache) {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added" && change.doc.data().status === 'pending') {
                                showToast(`üîî New Order: ${change.doc.data().buyerName}`, 'info');
                                playNotificationSound();
                            }
                            if (change.type === "modified" && change.doc.data().lastMsg && change.doc.data().lastMsgSender !== uid) {
                                showToast(`üí¨ Message from Buyer`, 'info');
                                playNotificationSound();
                            }
                        });
                    }
                });
                const qBuyer = query(collection(db, 'deals'), where('buyerId', '==', uid));
                onSnapshot(qBuyer, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified") {
                            if (change.doc.data().status === 'accepted') {
                                showToast(`‚úÖ Deal Confirmed!`, 'success');
                                playNotificationSound();
                            }
                            if (change.doc.data().lastMsg && change.doc.data().lastMsgSender !== uid) {
                                showToast(`üí¨ Seller Message`, 'info');
                                playNotificationSound();
                            }
                        }
                    });
                });
            };

            // --- FULL PROFILE ---
            window.showFullProfile = async () => {
                 document.getElementById('prof-img').src = userProfile.photo || 'https://placehold.co/150';
                 document.getElementById('prof-name').innerText = userProfile.name;
                 document.getElementById('prof-mobile').innerText = userProfile.mobile;
                 document.getElementById('prof-address').innerText = userProfile.address;

                 const sentQ = query(collection(db, 'deals'), where('buyerId', '==', userId), orderBy('createdAt', 'desc'));
                 const receivedQ = query(collection(db, 'deals'), where('sellerId', '==', userId), orderBy('createdAt', 'desc'));

                 onSnapshot(sentQ, (snap) => {
                    let content = '<h3 class="font-bold text-indigo-700 mt-4 mb-2">Maine Jo Maanga (Sent)</h3>';
                    if(snap.empty) content += '<p class="text-xs text-gray-400">Koi request nahi bheji.</p>';
                    snap.forEach(d => {
                        const deal = d.data();
                        const color = deal.status === 'accepted' ? 'green' : 'yellow';
                        content += `
                        <div class="bg-white p-3 rounded-lg border-l-4 border-${color}-500 shadow-sm mb-2 cursor-pointer" onclick="showItemDetails('${deal.itemId}', '${deal.sellerId}')">
                            <div class="flex justify-between"><p class="font-bold text-sm">${deal.itemName || 'Item'}</p><span class="text-xs bg-${color}-100 text-${color}-700 px-2 py-0.5 rounded capitalize">${deal.status}</span></div>
                            <p class="text-xs text-gray-500">Seller Page</p>
                        </div>`;
                    });
                    document.getElementById('sent-deals-area').innerHTML = content;
                 });

                 onSnapshot(receivedQ, (snap) => {
                    let content = '<h3 class="font-bold text-indigo-700 mt-4 mb-2">Mujhse Jo Maanga (Received)</h3>';
                    if(snap.empty) content += '<p class="text-xs text-gray-400">Koi request nahi aayi.</p>';
                    snap.forEach(d => {
                        const deal = d.data();
                        const color = deal.status === 'accepted' ? 'green' : 'yellow';
                        content += `
                        <div class="bg-white p-3 rounded-lg border-l-4 border-${color}-500 shadow-sm mb-2 cursor-pointer" onclick="showItemDetails('${deal.itemId}', '${deal.sellerId}')">
                            <div class="flex justify-between"><p class="font-bold text-sm">${deal.itemName || 'Item'}</p><span class="text-xs bg-${color}-100 text-${color}-700 px-2 py-0.5 rounded capitalize">${deal.status}</span></div>
                            <p class="text-xs text-gray-500">Buyer: ${deal.buyerName}</p>
                        </div>`;
                    });
                    document.getElementById('received-deals-area').innerHTML = content;
                 });

                 showView('view-profile-full');
            };

            window.showView = (id) => {
                document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                window.scrollTo(0,0);
            };

            window.showToast = (msg, type) => {
                const t = document.getElementById('toast');
                const color = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-indigo-600');
                t.innerHTML = `<div class="${color} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 transform transition-all duration-300"><span>${msg}</span></div>`;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 4000);
            };

        } catch (error) { console.error(error); }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen relative pb-20">

    <audio id="notif-sound" src="data:audio/wav;base64,UklGRl9vT1ZAVX..."></audio> 
    <div id="toast" class="fixed top-5 right-5 z-50 transition-all duration-500 translate-y-20 opacity-0"></div>

    <!-- LOADING -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-500">Loading Bazaar...</p>
    </div>

    <!-- MODAL LOGISTICS -->
    <div id="modal-logistics" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-bounce-in">
            <h3 class="font-bold text-lg mb-4 text-indigo-900">Confirm Deal</h3>
            <input type="hidden" id="modal-deal-id">
            <div class="space-y-3">
                <div class="flex gap-2">
                    <div class="w-1/2"><label class="text-xs font-bold text-gray-500">Date</label><input type="date" id="deal-date" class="w-full p-2 border rounded-xl bg-slate-50"></div>
                    <div class="w-1/2"><label class="text-xs font-bold text-gray-500">Time</label><input type="time" id="deal-time" class="w-full p-2 border rounded-xl bg-slate-50"></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500">Location</label><input id="deal-place" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Address"></div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('modal-logistics').classList.add('hidden')" class="flex-1 py-3 bg-gray-100 rounded-xl">Cancel</button>
                <button onclick="confirmDeal()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 1. LOGIN (Updated with Password) -->
    <div id="view-login" class="app-view hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center mb-6 text-3xl">üõçÔ∏è</div>
        <h1 class="text-3xl font-bold text-slate-900 mb-8">Bazaar Login</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="login-mobile" type="tel" class="w-full p-4 border rounded-xl text-lg bg-slate-50 outline-none focus:border-indigo-500" placeholder="Mobile Number">
            <input id="login-pass" type="password" class="w-full p-4 border rounded-xl text-lg bg-slate-50 outline-none focus:border-indigo-500" placeholder="Password">
            <button id="btn-login" onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl shadow-indigo-200">Login</button>
            <p class="text-center text-gray-500 mt-4">Account nahi hai? <span onclick="showView('view-register')" class="text-indigo-600 font-bold cursor-pointer">Naya Banayein</span></p>
        </div>
    </div>

    <!-- 2. REGISTER (New Account) -->
    <div id="view-register" class="app-view hidden min-h-screen p-6 bg-white flex flex-col justify-center">
        <h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2>
        <div class="max-w-sm mx-auto w-full space-y-4">
            <div class="relative w-24 h-24 mx-auto mb-6 bg-slate-100 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center">
                <input id="reg-photo" type="file" class="absolute inset-0 opacity-0 z-10 w-full h-full">
                <span class="text-xs text-gray-400">Photo</span>
            </div>
            <input id="reg-name" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Full Name">
            <input id="reg-mobile" type="tel" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Mobile Number">
            <input id="reg-pass" type="password" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Password (Min 6 chars)">
            <textarea id="reg-address" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="City / Address"></textarea>
            <button id="btn-signup" onclick="handleSignup()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg">Create Account</button>
            <p class="text-center text-gray-500 mt-4">Already have account? <span onclick="showView('view-login')" class="text-indigo-600 font-bold cursor-pointer">Login</span></p>
        </div>
    </div>

    <!-- 4. HOME -->
    <div id="view-home" class="app-view hidden">
        <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b flex justify-between items-center px-4 h-16 shadow-sm">
            <div class="font-bold text-xl text-indigo-700 flex items-center gap-2"><span>üõçÔ∏è</span> Bazaar</div>
            <div onclick="showFullProfile()" class="flex items-center gap-2 cursor-pointer bg-indigo-50 py-1.5 px-3 rounded-full border border-indigo-100">
                <img class="w-6 h-6 rounded-full object-cover user-photo-display" src="">
                <span class="text-sm font-bold text-indigo-900 user-name-display">User</span>
            </div>
        </nav>
        <div class="flex border-b bg-white sticky top-16 z-30 shadow-sm">
            <button id="tab-items" onclick="switchHomeTab('items')" class="flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition">‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ (Items)</button>
            <button id="tab-requests" onclick="switchHomeTab('requests')" class="flex-1 py-3 font-bold text-gray-400 transition">‡§Æ‡§æ‡§Ç‡§ó (Requests)</button>
        </div>
        <main class="max-w-5xl mx-auto px-4 py-6 pb-24">
            <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
        <div class="fixed bottom-24 right-6 flex flex-col gap-4 z-30">
            <button onclick="showView('view-request-add')" class="w-12 h-12 bg-white text-orange-500 rounded-full shadow-lg border border-orange-100 flex items-center justify-center transform hover:scale-110 transition" title="Ask Item">üì¢</button>
            <button onclick="showView('view-sell')" class="w-14 h-14 bg-indigo-600 text-white rounded-full shadow-xl shadow-indigo-300 flex items-center justify-center text-2xl transform hover:scale-110 transition">‚ûï</button>
        </div>
    </div>

    <!-- 5. SELL -->
    <div id="view-sell" class="app-view hidden bg-white min-h-screen">
        <div class="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-40">
            <button onclick="showView('view-home')" class="p-2 rounded-full hover:bg-slate-100">‚¨Ö</button>
            <h2 class="font-bold text-xl">Sell Item</h2>
        </div>
        <div class="p-6 max-w-lg mx-auto">
            <form id="form-sell" onsubmit="submitSell(event)" class="space-y-4">
                <div class="relative h-40 bg-slate-50 border-2 border-dashed border-indigo-200 rounded-xl flex items-center justify-center">
                    <input id="inp-file" type="file" class="absolute inset-0 opacity-0 w-full h-full z-10">
                    <span class="text-indigo-400 font-bold">üì∏ Click to Upload Photo</span>
                </div>
                <input name="name" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-indigo-100" placeholder="Product Name" required>
                <div class="flex gap-4">
                    <input name="price" type="number" class="w-1/2 p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Price ‚Çπ" required>
                    <input name="category" class="w-1/2 p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Category" required>
                </div>
                <textarea name="desc" class="w-full p-3 bg-slate-50 rounded-xl border outline-none" placeholder="Description..."></textarea>
                <button class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Post Ad</button>
            </form>
        </div>
    </div>

    <!-- 6. ADD REQUEST -->
    <div id="view-request-add" class="app-view hidden bg-white min-h-screen">
        <div class="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-40">
            <button onclick="showView('view-home')" class="p-2 rounded-full hover:bg-slate-100">‚¨Ö</button>
            <h2 class="font-bold text-xl">Request Item</h2>
        </div>
        <div class="p-6 max-w-lg mx-auto">
            <div class="bg-orange-50 text-orange-800 p-4 rounded-xl text-sm mb-6 border border-orange-100">
                Kuch chahiye jo market mein nahi mil raha? Yahan post karein.
            </div>
            <form id="form-request" onsubmit="submitRequest(event)" class="space-y-4">
                <input id="req-name" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-orange-100" placeholder="Item Name" required>
                <textarea id="req-desc" class="w-full p-3 bg-slate-50 rounded-xl border outline-none focus:ring-2 ring-orange-100" placeholder="Details" required></textarea>
                <button class="w-full py-4 bg-orange-500 text-white font-bold rounded-xl shadow-lg shadow-orange-200">Post Request</button>
            </form>
        </div>
    </div>

    <!-- 7. DETAILS & CHAT -->
    <div id="view-details" class="app-view hidden bg-white min-h-screen pb-20">
        <div class="relative h-72 bg-slate-900">
            <img id="det-img" class="w-full h-full object-cover opacity-90">
            <button onclick="showView('view-home')" class="absolute top-4 left-4 bg-white/20 backdrop-blur p-2 rounded-full text-white hover:bg-white/40 transition-colors">‚¨Ö</button>
        </div>
        <div class="max-w-3xl mx-auto -mt-6 relative bg-white rounded-t-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <h2 id="det-title" class="text-2xl font-bold text-slate-800 w-2/3 leading-tight">Title</h2>
                <p id="det-price" class="text-2xl font-bold text-indigo-600">‚Çπ0</p>
            </div>
            <p id="det-desc" class="text-slate-600 leading-relaxed mb-6">Desc...</p>
            <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6">
                <img id="det-seller-photo" class="w-12 h-12 rounded-full object-cover bg-white border">
                <div>
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Owner</p>
                    <p id="det-seller-name" class="font-bold text-slate-800">Name</p>
                    <p id="det-seller-mobile" class="text-xs text-gray-500">Mobile Hidden</p>
                </div>
            </div>
            <div id="deal-controls" class="mb-8"></div>
            <div class="border-t pt-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">üí¨ Discussion</h3>
                <div id="chat-messages" class="chat-box bg-slate-50 rounded-xl border border-slate-200 p-4 mb-4 overflow-y-auto shadow-inner"></div>
                <form onsubmit="sendChat(event)" class="flex gap-2">
                    <input id="inp-chat" class="flex-1 p-3 bg-white border rounded-xl outline-none focus:ring-2 ring-indigo-100" placeholder="Type a message...">
                    <button class="bg-indigo-600 text-white px-5 rounded-xl font-bold shadow-lg">Send</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 8. FULL PROFILE -->
    <div id="view-profile-full" class="app-view hidden bg-white min-h-screen">
        <div class="bg-indigo-600 p-6 text-white pt-10 pb-20 relative rounded-b-[2.5rem] shadow-xl">
            <button onclick="showView('view-home')" class="absolute top-4 left-4 bg-white/20 p-2 rounded-full">‚¨Ö</button>
            <div class="flex flex-col items-center">
                <img id="prof-img" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover shadow-lg mb-3" src="">
                <h2 id="prof-name" class="text-2xl font-bold">User</h2>
                <p id="prof-mobile" class="text-indigo-200">Mobile</p>
            </div>
        </div>
        <div class="max-w-3xl mx-auto px-6 -mt-12">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div><p class="text-gray-400 text-xs font-bold uppercase">Address</p><p id="prof-address" class="text-slate-800 font-medium mt-1">Address...</p></div>
                </div>
                <button onclick="handleLogout()" class="w-full py-2 text-red-500 border border-red-100 rounded-lg text-sm font-bold hover:bg-red-50">Logout</button>
            </div>
            <h2 class="text-xl font-bold mb-4">My Deals</h2>
            <div id="history-list" class="space-y-3 pb-10">
                <div id="sent-deals-area"></div>
                <div id="received-deals-area"></div>
            </div>
        </div>
    </div>

</body>
</html>
