<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazaar AI</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error:", message);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .chat-box { height: 250px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Vibrant Gradient */
        .bg-theme { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%); }
        .text-theme { background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* AI Gradient Button */
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white; border: none;
        }
        .btn-ai:hover { opacity: 0.9; transform: scale(1.02); }
        
        /* Sold Out Overlay */
        .sold-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 10;
        }
        .sold-badge {
            background: #ef4444; color: white; padding: 5px 15px; 
            border-radius: 20px; font-weight: bold; transform: rotate(-10deg);
            border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmBGDRtxUt74omyAi6YH9BySWm7kUjpAU",
            authDomain: "reseller-729f0.firebaseapp.com",
            projectId: "reseller-729f0",
            storageBucket: "reseller-729f0.firebasestorage.app",
            messagingSenderId: "225176781360",
            appId: "1:225176781360:web:acb5099ac84cd4da87e3f5"
        };

        // --- 2. GEMINI AI CONFIGURATION ---
        const manualGeminiKey = "AIzaSyA-H3Cg7BkGIV7W9niiY3HbURjPPT9DXmo"; 

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                loginTitle: "Welcome Back",
                mobilePlace: "Mobile Number",
                passPlace: "Password",
                loginBtn: "Login Securely",
                noAcc: "New here?",
                createOne: "Join Now",
                createTitle: "Join Bazaar AI",
                fullName: "Full Name",
                bioPlace: "Your Bio (e.g. Gadget Lover)",
                addrPlace: "City / Area",
                createBtn: "Start Journey",
                tabItems: "Market",
                tabReq: "Requests",
                sellItem: "Sell Item",
                reqItem: "Request Item",
                search: "Search...",
                chat: "Chat",
                dealReq: "Deal Requests",
                myDeals: "My Deals",
                soldOut: "SOLD OUT",
                iHave: "I Have This",
                accept: "Accept",
                reject: "Reject",
                confirm: "Confirm Deal",
                logout: "Logout"
            },
            hi: {
                loginTitle: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à",
                mobilePlace: "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞",
                passPlace: "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°",
                loginBtn: "‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç",
                noAcc: "‡§®‡§Ø‡•á ‡§π‡•à‡§Ç?",
                createOne: "‡§ú‡•Å‡•ú‡•á‡§Ç",
                createTitle: "‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç",
                fullName: "‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ",
                bioPlace: "‡§Ö‡§™‡§®‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á: ‡§ó‡•à‡§ú‡•á‡§ü ‡§™‡•ç‡§∞‡•á‡§Æ‡•Ä)",
                addrPlace: "‡§∂‡§π‡§∞ / ‡§™‡§§‡§æ",
                createBtn: "‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
                tabItems: "‡§¨‡§æ‡§ú‡§º‡§æ‡§∞",
                tabReq: "‡§Æ‡§æ‡§Ç‡§ó",
                sellItem: "‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¨‡•á‡§ö‡•á‡§Ç",
                reqItem: "‡§Æ‡§æ‡§Ç‡§ó ‡§°‡§æ‡§≤‡•á‡§Ç",
                search: "‡§¢‡•Ç‡§Ç‡§¢‡•á‡§Ç...",
                chat: "‡§¨‡§æ‡§§‡§ö‡•Ä‡§§",
                dealReq: "‡§∏‡•å‡§¶‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß",
                myDeals: "‡§Æ‡•á‡§∞‡•á ‡§∏‡•å‡§¶‡•á",
                soldOut: "‡§¨‡§ø‡§ï ‡§ó‡§Ø‡§æ",
                iHave: "‡§Æ‡•á‡§∞‡•á ‡§™‡§æ‡§∏ ‡§π‡•à",
                accept: "‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç",
                reject: "‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞",
                confirm: "‡§∏‡•å‡§¶‡§æ ‡§™‡§ï‡•ç‡§ï‡§æ ‡§ï‡§∞‡•á‡§Ç",
                logout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü"
            }
        };

        let currentLang = 'en'; 

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            let userId = null;
            let userName = null;
            let userProfile = {};

            // Auth Listener
            onAuthStateChanged(auth, async (user) => {
                document.getElementById('loading-screen').classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    await checkUserProfile(userId);
                } else {
                    showView('view-login');
                }
            });

            // --- PASSWORD TOGGLE ---
            window.togglePassword = (inputId, iconId) => {
                const input = document.getElementById(inputId);
                const icon = document.getElementById(iconId);
                if (input.type === "password") {
                    input.type = "text";
                    icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />`;
                } else {
                    input.type = "password";
                    icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`;
                }
            };

            // --- GEMINI AI FUNCTIONS ---
            
            // Helper to call Gemini
            async function callGeminiAPI(prompt, imageBase64 = null) {
                const apiKey = typeof apiKey !== 'undefined' ? apiKey : manualGeminiKey; 
                
                if (!apiKey) {
                    alert("Gemini API Key missing! Code mein 'manualGeminiKey' bharein.");
                    return null;
                }

                const parts = [{ text: prompt }];
                if (imageBase64) {
                    const base64Data = imageBase64.split(',')[1];
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Data } });
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: parts }] })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    console.error("Gemini Error:", e);
                    alert("AI Error: " + e.message);
                    return null;
                }
            }

            // 1. Magic Scan (Image -> Details)
            window.magicScan = async () => {
                const file = document.getElementById('inp-file').files[0];
                if (!file) { showToast("Please upload a photo first!", "error"); return; }

                const btn = document.getElementById('btn-magic-scan');
                const originalText = btn.innerHTML;
                btn.innerHTML = "‚ú® Scanning..."; btn.disabled = true;

                try {
                    const photoBase64 = await compressImage(file);
                    
                    const prompt = `Analyze this image of a used item for an Indian marketplace. 
                    Return ONLY a JSON object (no markdown) with these fields:
                    {
                        "name": "Short attractive title (in English)",
                        "category": "One word category (e.g. Mobile, Furniture)",
                        "price": "Estimated resale value in INR (number only)",
                        "description": "A catchy sales description mixing Hindi and English (Hinglish). Mention condition based on visual."
                    }`;

                    const result = await callGeminiAPI(prompt, photoBase64);
                    if (result) {
                        const jsonStr = result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const data = JSON.parse(jsonStr);
                        
                        document.querySelector('#form-sell input[name="name"]').value = data.name;
                        document.querySelector('#form-sell input[name="price"]').value = data.price;
                        document.querySelector('#form-sell input[name="category"]').value = data.category;
                        document.querySelector('#form-sell textarea[name="desc"]').value = data.description;
                        
                        showToast("‚ú® AI ne form bhar diya!", "success");
                    }
                } catch (e) {
                    console.error(e);
                    showToast("AI Scan Failed. Try manually.", "error");
                } finally {
                    btn.innerHTML = originalText; btn.disabled = false;
                }
            };

            // 2. AI Writer (Text -> Description)
            window.aiWriteDesc = async () => {
                const name = document.querySelector('#form-sell input[name="name"]').value;
                const cat = document.querySelector('#form-sell input[name="category"]').value;
                
                if(!name) { showToast("Pehle naam likhein", "error"); return; }

                const btn = document.getElementById('btn-ai-write');
                btn.innerHTML = "‚ú® Writing..."; btn.disabled = true;

                const prompt = `Write a short, attractive Hinglish sales description for selling a used '${name}' (Category: ${cat}) on a local bazaar app. Keep it under 200 characters.`;
                
                const text = await callGeminiAPI(prompt);
                if(text) {
                    document.querySelector('#form-sell textarea[name="desc"]').value = text;
                }
                
                btn.innerHTML = "‚ú® Write for me"; btn.disabled = false;
            };


            // --- CORE FUNCTIONS ---
            const checkUserProfile = async (uid) => {
                const userRef = doc(db, 'users', uid);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    userName = userProfile.name;
                    if(userProfile.language) setLanguage(userProfile.language);
                    else { showView('view-language'); return; }
                    showView('view-home');
                    startItemsListener(); 
                    updateUserDisplay();
                    startNotificationListener(uid);
                } else {
                    showView('view-login');
                }
            };

            const updateUserDisplay = () => {
                document.querySelectorAll('.user-name-display').forEach(el => el.textContent = userName || 'Guest');
                document.querySelectorAll('.user-photo-display').forEach(img => img.src = userProfile.photo || 'https://placehold.co/100');
            };

            // --- LANGUAGE LOGIC ---
            window.setLanguage = async (lang) => {
                currentLang = lang;
                const t = translations[lang];
                const setText = (id, text) => { if(document.getElementById(id)) document.getElementById(id).innerText = text; };
                const setPlace = (id, text) => { if(document.getElementById(id)) document.getElementById(id).placeholder = text; };

                setText('txt-login-title', t.loginTitle);
                setPlace('login-mobile', t.mobilePlace);
                setPlace('login-pass', t.passPlace);
                setText('btn-login', t.loginBtn);
                setText('txt-create-title', t.createTitle);
                setPlace('reg-name', t.fullName);
                setPlace('reg-bio', t.bioPlace);
                setPlace('reg-address', t.addrPlace);
                setText('btn-signup', t.createBtn);
                setText('tab-items', t.tabItems);
                setText('tab-requests', t.tabReq);
                
                if(userId) await updateDoc(doc(db, 'users', userId), { language: lang });
                if(!document.getElementById('view-language').classList.contains('hidden')) {
                    showView('view-home'); startItemsListener();
                }
            };

            // --- AUTH UI ---
            window.handleLogin = async () => {
                const mobile = document.getElementById('login-mobile').value.trim();
                const pass = document.getElementById('login-pass').value.trim();
                if (mobile.length !== 10) { showToast('Invalid Mobile', 'error'); return; }
                if (!pass) { showToast('Enter Password', 'error'); return; }
                const email = `${mobile}@bazaar.com`;
                try { await signInWithEmailAndPassword(auth, email, pass); } 
                catch (error) { showToast("Login Failed: " + error.code, 'error'); }
            };

            window.handleSignup = async () => {
                const name = document.getElementById('reg-name').value.trim();
                const mobile = document.getElementById('reg-mobile').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();
                const bio = document.getElementById('reg-bio').value.trim();
                const address = document.getElementById('reg-address').value.trim();
                const file = document.getElementById('reg-photo').files[0];
                const btn = document.getElementById('btn-signup');

                if (name.length < 3 || mobile.length !== 10) { showToast('Check details', 'error'); return; }
                if (pass.length < 6) { showToast('Password min 6 chars', 'error'); return; }

                btn.innerText = "Creating..."; btn.disabled = true;
                let photoBase64 = null;
                if (file) {
                    try { photoBase64 = await compressImage(file); } 
                    catch(e) { showToast("Image Error", 'error'); btn.disabled = false; return; }
                }
                const email = `${mobile}@bazaar.com`;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    const user = userCredential.user;
                    await setDoc(doc(db, 'users', user.uid), {
                        name, mobile, bio, address, photo: photoBase64,
                        language: 'en', createdAt: serverTimestamp()
                    });
                    await updateProfile(user, { displayName: name });
                } catch (error) {
                    showToast(error.message, 'error');
                    btn.innerText = translations[currentLang].createBtn; btn.disabled = false;
                }
            };

            // --- NOTIFICATIONS ---
            const startNotificationListener = (uid) => {
                const playSound = () => { const a = document.getElementById('notif-sound'); if(a) a.play().catch(()=>{}); };
                const qSeller = query(collection(db, 'deals'), where('sellerId', '==', uid));
                onSnapshot(qSeller, (snapshot) => {
                    if (!snapshot.metadata.fromCache) {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added" && change.doc.data().status === 'pending') {
                                showToast(`üîî New Order: ${change.doc.data().buyerName}`, 'info'); playSound();
                            }
                        });
                    }
                });
                const qBuyer = query(collection(db, 'deals'), where('buyerId', '==', uid));
                onSnapshot(qBuyer, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified" && change.doc.data().status === 'accepted') {
                            showToast(`‚úÖ Deal Confirmed!`, 'success'); playSound();
                        }
                    });
                });
            };

            // --- TABS & LISTS ---
            window.switchHomeTab = (tab) => {
                document.getElementById('tab-items').className = "flex-1 py-3 font-bold text-gray-400 transition";
                document.getElementById('tab-requests').className = "flex-1 py-3 font-bold text-gray-400 transition";
                document.getElementById(`tab-${tab}`).className = "flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition";
                if(tab === 'items') startItemsListener(); else startRequestsListener();
            };

            window.startItemsListener = () => {
                const q = query(collection(db, 'items'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">Empty.</p>'; return; }
                    snap.forEach(d => {
                        const item = d.data();
                        const isSold = item.status === 'sold';
                        const div = document.createElement('div');
                        div.className = `bg-white rounded-2xl shadow-sm hover:shadow-lg transition overflow-hidden border border-gray-100 cursor-pointer fade-in relative ${isSold ? 'opacity-75' : ''}`;
                        if(!isSold) div.onclick = (e) => { if(!e.target.closest('button')) showItemDetails(d.id, item.sellerId); };
                        let soldOverlay = isSold ? `<div class="sold-overlay"><div class="sold-badge">${translations[currentLang].soldOut}</div></div>` : '';
                        div.innerHTML = `
                            ${soldOverlay}
                            <div class="relative h-48 overflow-hidden">
                                <img src="${item.imageData}" class="w-full h-full object-cover">
                                <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-3">
                                    <span class="text-white font-bold text-lg">‚Çπ ${item.price}</span>
                                </div>
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-gray-800 truncate">${item.name}</h3>
                                <p class="text-xs text-gray-500 mb-2">${item.category}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-gray-400">By: ${item.sellerName.split(' ')[0]}</span>
                                    ${!isSold ? `<button class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">Buy</button>` : ''}
                                </div>
                            </div>`;
                        list.appendChild(div);
                    });
                });
            };

            window.startRequestsListener = () => {
                const q = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('items-grid');
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">No requests.</p>'; return; }
                    snap.forEach(d => {
                        const req = d.data();
                        const div = document.createElement('div');
                        div.className = 'bg-white rounded-2xl p-5 shadow-sm border border-orange-100 relative fade-in';
                        div.innerHTML = `
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-bl-xl font-bold">WANTED</div>
                            <h3 class="font-bold text-lg text-gray-800">${req.itemName}</h3>
                            <p class="text-gray-600 text-sm mt-1">${req.description}</p>
                            <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-50">
                                <div class="flex items-center gap-2">
                                    <img src="${req.requesterPhoto || 'https://placehold.co/50'}" class="w-8 h-8 rounded-full object-cover">
                                    <p class="text-xs font-bold">${req.requesterName}</p>
                                </div>
                                ${req.requesterId !== userId ? 
                                `<button onclick="openResponseModal('${d.id}', '${req.requesterId}', '${req.itemName}')" class="bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow">${translations[currentLang].iHave}</button>` : ''}
                            </div>`;
                        list.appendChild(div);
                    });
                });
            };

            // --- I HAVE THIS ---
            window.openResponseModal = (reqId, requesterId, itemName) => {
                document.getElementById('resp-req-id').value = reqId;
                document.getElementById('resp-requester-id').value = requesterId;
                document.getElementById('resp-item-name').value = itemName;
                document.getElementById('modal-response').classList.remove('hidden');
            };

            window.submitResponse = async () => {
                const reqId = document.getElementById('resp-req-id').value;
                const requesterId = document.getElementById('resp-requester-id').value;
                const itemName = document.getElementById('resp-item-name').value;
                const condition = document.getElementById('resp-condition').value;
                const price = document.getElementById('resp-price').value;
                const file = document.getElementById('resp-photo').files[0];

                if(!price || !condition) { showToast("Enter Price & Condition", 'error'); return; }
                let photoBase64 = null;
                if (file) { try { photoBase64 = await compressImage(file); } catch(e){} }

                await addDoc(collection(db, 'deals'), {
                    itemId: reqId, sellerId: userId, sellerName: userName,
                    buyerId: requesterId, buyerName: 'Requester', itemName: itemName,
                    offerPrice: price, offerCondition: condition, offerPhoto: photoBase64,
                    status: 'proposal_sent', type: 'request_response', createdAt: serverTimestamp()
                });
                document.getElementById('modal-response').classList.add('hidden');
                showToast("Proposal Sent!", 'success');
            };

            // --- SUBMIT ---
            window.submitSell = async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-sell');
                const file = document.getElementById('inp-file').files[0];
                if(!file) { showToast('Photo required', 'error'); return; }
                const btn = document.getElementById('btn-post-ad');
                btn.disabled = true; btn.innerText = "Uploading...";

                try {
                    const photoBase64 = await compressImage(file);
                    await addDoc(collection(db, 'items'), {
                        name: form['name'].value, price: Number(form['price'].value),
                        category: form['category'].value, description: form['desc'].value,
                        imageData: photoBase64, sellerId: userId, sellerName: userName, 
                        status: 'available', createdAt: serverTimestamp()
                    });
                    form.reset();
                    btn.disabled = false; btn.innerText = "Post Ad";
                    showView('view-home'); switchHomeTab('items');
                } catch(err) { showToast(err.message, 'error'); btn.disabled = false; }
            };

            window.submitRequest = async (e) => {
                e.preventDefault();
                const name = document.getElementById('req-name').value;
                const desc = document.getElementById('req-desc').value;
                await addDoc(collection(db, 'requests'), {
                    itemName: name, description: desc,
                    requesterId: userId, requesterName: userName, requesterPhoto: userProfile.photo,
                    createdAt: serverTimestamp()
                });
                document.getElementById('form-request').reset();
                showView('view-home'); switchHomeTab('requests');
            };

            // --- DETAILS & DEALS ---
            let activeDealId = null;
            window.showItemDetails = async (itemId, sellerId) => {
                const iSnap = await getDoc(doc(db, 'items', itemId));
                const sSnap = await getDoc(doc(db, 'users', sellerId));
                if(!iSnap.exists()) return;
                const item = iSnap.data();
                const seller = sSnap.exists() ? sSnap.data() : {name:'User', mobile:'Hidden'};

                document.getElementById('det-img').src = item.imageData;
                document.getElementById('det-title').innerText = item.name;
                document.getElementById('det-price').innerText = `‚Çπ ${item.price}`;
                document.getElementById('det-desc').innerText = item.description || "No description";
                document.getElementById('det-seller-photo').src = seller.photo || 'https://placehold.co/100';
                document.getElementById('det-seller-name').innerText = seller.name;
                if (document.getElementById('det-seller-mobile')) document.getElementById('det-seller-mobile').innerText = seller.mobile;
                document.getElementById('det-seller-bio').innerText = seller.bio || "";
                
                const controls = document.getElementById('deal-controls');
                controls.innerHTML = '';
                
                const q = query(collection(db, 'deals'), where('itemId', '==', itemId));
                onSnapshot(q, (snap) => {
                    controls.innerHTML = '';
                    if (sellerId === userId) {
                        snap.forEach(d => {
                            const deal = d.data();
                            if(deal.status === 'pending') {
                                controls.innerHTML += `<div class="bg-indigo-50 p-3 rounded-lg border flex justify-between items-center"><div><p class="font-bold text-sm">${deal.buyerName}</p></div><button onclick="acceptDeal('${d.id}', '${itemId}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Accept</button></div>`;
                            }
                        });
                    } else {
                        const myDeal = snap.docs.find(d => d.data().buyerId === userId);
                        if (!myDeal) {
                            controls.innerHTML = `<button onclick="sendDealRequest('${itemId}', '${sellerId}')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Yes, I want to buy</button>`;
                        } else {
                            const status = myDeal.data().status;
                            activeDealId = myDeal.id;
                            if(status === 'pending') controls.innerHTML = `<div class="bg-yellow-100 p-3 rounded-xl text-center font-bold">Request Sent</div>`;
                            else if(status === 'accepted') controls.innerHTML = `<div class="bg-green-100 p-3 rounded-xl text-center font-bold">Deal Confirmed!</div>`;
                        }
                    }
                    if(activeDealId) setupChat(activeDealId);
                });
                showView('view-details');
            };

            window.sendDealRequest = async (itemId, sellerId) => {
                await addDoc(collection(db, 'deals'), {
                    itemId, sellerId: sellerId, buyerId: userId, buyerName: userName, 
                    itemName: document.getElementById('det-title').innerText, 
                    status: 'pending', createdAt: serverTimestamp()
                });
                showToast("Request Sent!", 'success');
            };

            window.acceptDeal = (dealId, itemId) => {
                document.getElementById('modal-deal-id').value = dealId;
                document.getElementById('modal-item-id').value = itemId || '';
                document.getElementById('modal-logistics').classList.remove('hidden');
            };

            window.confirmDeal = async () => {
                const dealId = document.getElementById('modal-deal-id').value;
                const itemId = document.getElementById('modal-item-id').value;
                const date = document.getElementById('deal-date').value;
                const time = document.getElementById('deal-time').value;
                const place = document.getElementById('deal-place').value;
                if(!date || !time || !place) { showToast("Fill details", 'error'); return; }
                await updateDoc(doc(db, 'deals', dealId), { status: 'accepted', meetDate: date, meetTime: time, meetPlace: place });
                if(itemId) await updateDoc(doc(db, 'items', itemId), { status: 'sold' });
                document.getElementById('modal-logistics').classList.add('hidden');
                showToast("Deal Confirmed!", 'success');
            };

            const setupChat = (dealId) => {
                const chatDiv = document.getElementById('chat-messages');
                const q = query(collection(db, 'deals', dealId, 'messages'), orderBy('createdAt', 'asc'));
                onSnapshot(q, (snap) => {
                    chatDiv.innerHTML = '';
                    snap.forEach(d => {
                        const msg = d.data();
                        const isMe = msg.senderId === userId;
                        chatDiv.innerHTML += `<div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-2"><div class="px-3 py-2 rounded-2xl text-xs max-w-[80%] ${isMe ? 'bg-indigo-600 text-white' : 'bg-white border'}">${msg.text}</div></div>`;
                    });
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                });
            };

            window.sendChat = async (e) => {
                e.preventDefault();
                const txt = document.getElementById('inp-chat').value.trim();
                if(!txt || !activeDealId) return;
                await addDoc(collection(db, 'deals', activeDealId, 'messages'), { text: txt, senderId: userId, createdAt: serverTimestamp() });
                await updateDoc(doc(db, 'deals', activeDealId), { lastMsg: txt, lastMsgSender: userId });
                document.getElementById('inp-chat').value = '';
            };

            // --- PROFILE ---
            window.showFullProfile = async () => {
                 document.getElementById('prof-img').src = userProfile.photo || 'https://placehold.co/150';
                 document.getElementById('prof-name').innerText = userProfile.name;
                 document.getElementById('prof-bio').innerText = userProfile.bio || 'No Bio';

                 // Update Stats
                 const itemsQ = query(collection(db, 'items'), where('sellerId', '==', userId));
                 onSnapshot(itemsQ, s => {
                     if(document.getElementById('stat-items')) document.getElementById('stat-items').innerText = s.size;
                 });

                 const sentQ = query(collection(db, 'deals'), where('buyerId', '==', userId));
                 const receivedQ = query(collection(db, 'deals'), where('sellerId', '==', userId));

                 onSnapshot(sentQ, (snap) => {
                    let deals = []; snap.forEach(d => deals.push({id: d.id, ...d.data()}));
                    deals.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    
                    // SAFE DOM UPDATE
                    if(document.getElementById('stat-bought')) document.getElementById('stat-bought').innerText = deals.length;

                    let html = '';
                    deals.forEach(deal => {
                        if (deal.type === 'request_response' && deal.status === 'proposal_sent') {
                            html += `<div class="bg-orange-50 p-3 rounded-lg border border-orange-200 mb-2"><p class="text-sm font-bold">Offer: ${deal.itemName}</p><p class="text-xs">‚Çπ${deal.offerPrice}</p><button onclick="acceptDeal('${deal.id}', null)" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-xs">Accept</button></div>`;
                        } else {
                            html += `<div class="bg-white p-3 rounded-lg shadow-sm mb-2 border"><p class="font-bold text-sm">${deal.itemName || 'Item'}</p><span class="text-xs bg-gray-100 px-2 rounded">${deal.status}</span></div>`;
                        }
                    });
                    const sentArea = document.getElementById('sent-deals-area');
                    if(sentArea) sentArea.innerHTML = html || '<p class="text-xs text-gray-400">No Activity</p>';
                 });

                 onSnapshot(receivedQ, (snap) => {
                    let deals = []; snap.forEach(d => deals.push({id: d.id, ...d.data()}));
                    deals.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    
                    // SAFE DOM UPDATE
                    if(document.getElementById('stat-sold')) document.getElementById('stat-sold').innerText = deals.filter(d => d.status === 'accepted').length;

                    let html = '';
                    deals.forEach(deal => {
                        html += `<div class="bg-white p-3 rounded-lg shadow-sm mb-2 border"><p class="font-bold text-sm">${deal.itemName || 'Item'}</p><p class="text-xs">Buyer: ${deal.buyerName}</p><span class="text-xs bg-gray-100 px-2 rounded">${deal.status}</span></div>`;
                    });
                    const receivedArea = document.getElementById('received-deals-area');
                    if(receivedArea) receivedArea.innerHTML = html || '<p class="text-xs text-gray-400">No Activity</p>';
                 });
                 showView('view-profile-full');
            };

            const compressImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader(); reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 800; let w = img.width, h = img.height;
                            if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    };
                });
            };

            window.showView = (id) => {
                document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            };
            window.handleLogout = () => { signOut(auth); showView('view-login'); };
            window.showToast = (msg, type) => {
                const t = document.getElementById('toast');
                t.innerHTML = `<div class="${type==='error'?'bg-red-500':'bg-green-500'} text-white px-4 py-3 rounded shadow">${msg}</div>`;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 4000);
            };

        } catch (error) { console.error(error); }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen relative pb-20">

    <div id="toast" class="fixed top-5 right-5 z-50 transition-all duration-500 translate-y-20 opacity-0"></div>
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <!-- LOGO IN LOADER -->
        <svg class="w-20 h-20 mb-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-indigo-900 font-bold text-xl">Bazaar AI</p>
    </div>
    <audio id="notif-sound" src="data:audio/wav;base64,UklGRl9vT1ZAVX..."></audio>

    <!-- LANGUAGE SELECTION -->
    <div id="view-language" class="app-view hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <h2 class="text-2xl font-bold mb-8">Select Language / ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</h2>
        <div class="space-y-4 w-full max-w-sm">
            <button onclick="setLanguage('en')" class="w-full p-4 border-2 border-indigo-100 rounded-xl hover:bg-indigo-50 font-bold text-lg flex justify-between items-center">English <span>üá¨üáß</span></button>
            <button onclick="setLanguage('hi')" class="w-full p-4 border-2 border-orange-100 rounded-xl hover:bg-orange-50 font-bold text-lg flex justify-between items-center">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi) <span>üáÆüá≥</span></button>
        </div>
    </div>

    <!-- LOGISTICS MODAL -->
    <div id="modal-logistics" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-indigo-900">Confirm Deal Details</h3>
            <input type="hidden" id="modal-deal-id"><input type="hidden" id="modal-item-id">
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="date" id="deal-date" class="w-1/2 p-2 border rounded-xl">
                    <input type="time" id="deal-time" class="w-1/2 p-2 border rounded-xl">
                </div>
                <input id="deal-place" class="w-full p-3 border rounded-xl" placeholder="Location">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('modal-logistics').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 rounded-xl">Cancel</button>
                <button onclick="confirmDeal()" class="flex-1 py-2 bg-green-600 text-white rounded-xl font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <!-- RESPONSE MODAL -->
    <div id="modal-response" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-indigo-900">I Have This Item</h3>
            <input type="hidden" id="resp-req-id"><input type="hidden" id="resp-requester-id"><input type="hidden" id="resp-item-name">
            <div class="space-y-3">
                <input id="resp-price" type="number" class="w-full p-3 border rounded-xl" placeholder="My Price (‚Çπ)">
                <input id="resp-condition" class="w-full p-3 border rounded-xl" placeholder="Condition">
                <div class="relative h-24 bg-slate-50 border-2 border-dashed rounded-xl flex items-center justify-center">
                    <input id="resp-photo" type="file" class="absolute inset-0 opacity-0 w-full h-full"><span class="text-xs text-gray-400">Photo (Optional)</span>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('modal-response').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 rounded-xl">Cancel</button>
                <button onclick="submitResponse()" class="flex-1 py-2 bg-green-600 text-white rounded-xl font-bold">Send Offer</button>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="view-login" class="app-view hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <!-- LOGO -->
        <div class="w-20 h-20 bg-theme rounded-3xl flex items-center justify-center mb-6 text-white shadow-xl shadow-indigo-200 transform -rotate-6">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
        </div>
        
        <h1 id="txt-login-title" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-pink-600 mb-8">Bazaar AI</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="login-mobile" type="tel" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-lg focus:border-indigo-500 outline-none transition-colors" placeholder="Mobile Number">
            
            <!-- PASSWORD WITH TOGGLE -->
            <div class="relative">
                <input id="login-pass" type="password" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-lg focus:border-indigo-500 outline-none transition-colors" placeholder="Password">
                <button onclick="togglePassword('login-pass', 'icon-login-eye')" class="absolute right-4 top-4 text-gray-400">
                    <svg id="icon-login-eye" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </button>
            </div>

            <button id="btn-login" onclick="handleLogin()" class="w-full bg-theme text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-200 hover:scale-[1.02] transition-transform">Login</button>
            <p class="text-center text-gray-500 mt-4"><span id="txt-no-acc">No account?</span> <span onclick="showView('view-register')" class="text-indigo-600 font-bold cursor-pointer hover:underline">Create New</span></p>
        </div>
    </div>

    <!-- REGISTER -->
    <div id="view-register" class="app-view hidden min-h-screen p-6 bg-white flex flex-col justify-center">
        <h2 id="txt-create-title" class="text-3xl font-bold mb-6 text-center text-indigo-900">Create Account</h2>
        <div class="max-w-sm mx-auto w-full space-y-4">
            <div class="relative w-24 h-24 mx-auto mb-4 bg-indigo-50 rounded-full border-2 border-dashed border-indigo-300 flex items-center justify-center group cursor-pointer">
                <input id="reg-photo" type="file" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                <span class="text-2xl group-hover:scale-110 transition-transform">üì∏</span>
            </div>
            <input id="reg-name" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Full Name">
            <input id="reg-mobile" type="tel" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Mobile">
            
            <!-- REG PASS TOGGLE -->
            <div class="relative">
                <input id="reg-pass" type="password" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Password (Min 6)">
                <button onclick="togglePassword('reg-pass', 'icon-reg-eye')" class="absolute right-4 top-4 text-gray-400">
                    <svg id="icon-reg-eye" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                </button>
            </div>

            <input id="reg-bio" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Bio">
            <textarea id="reg-address" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Address"></textarea>
            <button id="btn-signup" onclick="handleSignup()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-700">Create Account</button>
            <p class="text-center text-gray-500 mt-4"><span onclick="showView('view-login')" class="text-indigo-600 font-bold cursor-pointer">Login</span></p>
        </div>
    </div>

    <!-- HOME -->
    <div id="view-home" class="app-view hidden">
        <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b flex justify-between items-center px-4 h-16 shadow-sm">
            <div class="font-extrabold text-xl text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-pink-600">Bazaar AI</div>
            <div onclick="showFullProfile()" class="flex items-center gap-2 cursor-pointer bg-indigo-50 py-1.5 px-3 rounded-full border border-indigo-100 hover:bg-indigo-100 transition">
                <img class="w-7 h-7 rounded-full object-cover user-photo-display border border-indigo-200" src="">
                <span class="text-sm font-bold text-indigo-900 user-name-display">User</span>
            </div>
        </nav>
        <div class="flex border-b bg-white sticky top-16 z-30 shadow-sm">
            <button id="tab-items" onclick="switchHomeTab('items')" class="flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition">Items</button>
            <button id="tab-requests" onclick="switchHomeTab('requests')" class="flex-1 py-3 font-bold text-gray-400 transition">Requests</button>
        </div>
        <main class="max-w-5xl mx-auto px-4 py-6 pb-24">
            <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
        <div class="fixed bottom-24 right-6 flex flex-col gap-4 z-30">
            <button onclick="showView('view-request-add')" class="w-12 h-12 bg-white text-orange-500 rounded-full shadow-lg border border-orange-100 flex items-center justify-center text-lg hover:scale-110 transition">üì¢</button>
            <button onclick="showView('view-sell')" class="w-14 h-14 bg-theme text-white rounded-full shadow-xl shadow-purple-300 flex items-center justify-center text-2xl hover:scale-110 transition">‚ûï</button>
        </div>
    </div>

    <!-- SELL -->
    <div id="view-sell" class="app-view hidden bg-white min-h-screen p-6">
        <button onclick="showView('view-home')" class="mb-4 text-gray-500">‚¨Ö Back</button><h2 class="text-2xl font-bold mb-6 text-gray-800">Sell Item</h2>
        <form id="form-sell" onsubmit="submitSell(event)" class="space-y-4">
            <div class="relative h-48 bg-slate-50 border-2 border-dashed border-indigo-200 rounded-2xl flex items-center justify-center overflow-hidden group">
                <input id="inp-file" type="file" class="absolute inset-0 opacity-0 w-full h-full z-10 cursor-pointer">
                <div class="text-center">
                    <span class="text-4xl block mb-2 group-hover:scale-110 transition">üì∏</span>
                    <span class="text-indigo-400 font-bold">Upload Photo</span>
                </div>
            </div>
            
            <!-- AI BUTTONS -->
            <div class="flex gap-2">
                <button type="button" id="btn-magic-scan" onclick="magicScan()" class="btn-ai flex-1 py-3 rounded-xl text-sm font-bold shadow-lg shadow-purple-200">‚ú® AI Scan Image</button>
            </div>

            <input name="name" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:border-indigo-500 outline-none" placeholder="Product Name" required>
            <div class="flex gap-4">
                <input name="price" type="number" class="w-1/2 p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Price ‚Çπ" required>
                <input name="category" class="w-1/2 p-4 border-2 border-gray-100 rounded-2xl bg-gray-50" placeholder="Category" required>
            </div>
            
            <div class="relative">
                <textarea name="desc" class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 h-32" placeholder="Description..."></textarea>
                <button type="button" id="btn-ai-write" onclick="aiWriteDesc()" class="absolute bottom-3 right-3 text-xs bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-200 transition">‚ú® Write AI</button>
            </div>

            <button id="btn-post-ad" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700">Post Ad</button>
        </form>
    </div>

    <!-- REQUEST ADD -->
    <div id="view-request-add" class="app-view hidden bg-white min-h-screen p-6">
        <button onclick="showView('view-home')" class="mb-4">‚¨Ö Back</button><h2 class="text-2xl font-bold mb-4">Request Item</h2>
        <form id="form-request" onsubmit="submitRequest(event)" class="space-y-4">
            <input id="req-name" class="w-full p-4 border-2 rounded-2xl" placeholder="What do you need?" required>
            <textarea id="req-desc" class="w-full p-4 border-2 rounded-2xl h-32" placeholder="Details" required></textarea>
            <button class="w-full py-4 bg-orange-500 text-white rounded-2xl font-bold shadow-lg">Post Request</button>
        </form>
    </div>

    <!-- DETAILS -->
    <div id="view-details" class="app-view hidden bg-white min-h-screen pb-20">
        <div class="relative h-80 bg-slate-900">
            <img id="det-img" class="w-full h-full object-cover opacity-90">
            <button onclick="showView('view-home')" class="absolute top-4 left-4 bg-white/20 backdrop-blur p-2 rounded-full text-white hover:bg-white/40 transition-colors">‚¨Ö</button>
        </div>
        <div class="max-w-3xl mx-auto -mt-10 relative bg-white rounded-t-[2.5rem] p-8 shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <h2 id="det-title" class="text-3xl font-bold text-slate-800 w-2/3 leading-tight"></h2>
                <p id="det-price" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-pink-600"></p>
            </div>
            <p id="det-desc" class="text-slate-600 leading-relaxed mb-8 text-lg"></p>

            <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 mb-8 flex items-center gap-4">
                <img id="det-seller-photo" class="w-14 h-14 rounded-full object-cover bg-white border-2 border-indigo-200">
                <div>
                    <p class="text-xs text-indigo-400 uppercase font-bold tracking-wider mb-1">Seller</p>
                    <p id="det-seller-name" class="font-bold text-slate-900 text-lg"></p>
                    <p id="det-seller-mobile" class="text-sm text-slate-600 font-medium"></p> <!-- Added this -->
                    <p id="det-seller-bio" class="text-xs text-slate-500 italic"></p>
                </div>
            </div>

            <div id="deal-controls" class="mb-8"></div>

            <div class="border-t pt-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">üí¨ Chat</h3>
                <div id="chat-messages" class="chat-box bg-slate-50 rounded-2xl border border-gray-100 p-4 mb-4 overflow-y-auto"></div>
                <form onsubmit="sendChat(event)" class="flex gap-2">
                    <input id="inp-chat" class="flex-1 p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-indigo-300" placeholder="Type message...">
                    <button class="bg-indigo-600 text-white px-6 rounded-2xl font-bold shadow-lg">‚û§</button>
                </form>
            </div>
        </div>
    </div>

    <!-- CREATIVE PROFILE -->
    <div id="view-profile-full" class="app-view hidden bg-gray-50 min-h-screen">
        <!-- Creative Header -->
        <div class="bg-theme p-6 pt-10 pb-32 rounded-b-[3rem] shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div class="relative z-10 flex justify-between items-start text-white">
                <button onclick="showView('view-home')" class="bg-white/20 p-2 rounded-full hover:bg-white/30">‚¨Ö</button>
                <button onclick="handleLogout()" class="bg-red-500/80 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-red-600">Logout</button>
            </div>
            <div class="flex flex-col items-center mt-4 relative z-10">
                <div class="p-1 bg-white/30 rounded-full backdrop-blur-md">
                    <img id="prof-img" class="w-28 h-28 rounded-full border-4 border-white bg-white object-cover shadow-lg">
                </div>
                <h2 id="prof-name" class="text-3xl font-bold text-white mt-3"></h2>
                <p id="prof-bio" class="text-indigo-100 text-center mt-1 max-w-xs"></p>
                <p id="prof-address" class="text-indigo-200 text-xs uppercase font-bold mt-2 tracking-widest bg-indigo-900/30 px-3 py-1 rounded-full"></p>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="max-w-3xl mx-auto px-6 -mt-20 relative z-20">
            <div class="grid grid-cols-3 gap-2 mb-8">
                <div class="bg-white p-3 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-indigo-600" id="stat-items">0</p>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Ads</p>
                </div>
                <div class="bg-white p-3 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-green-500" id="stat-sold">0</p>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Sold</p>
                </div>
                <div class="bg-white p-3 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-orange-500" id="stat-bought">0</p>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Bought</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm p-6 min-h-[300px]">
                <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                    <span class="bg-indigo-100 text-indigo-600 p-1 rounded">üì¶</span> My Deals
                </h2>
                
                <div id="sent-deals-area"></div>
                <div class="my-6 border-t border-dashed border-gray-200"></div>
                <div id="received-deals-area"></div>
            </div>
            
            <div class="h-20"></div>
        </div>
    </div>

</body>
</html>

